Selector=function(a){var b=this;b.drawningboard=a,b.width=0,b.height=0,b.target=[],b.explodedtarget=[],b.contextmenu,b.selector=[],b.selector.bg=b.drawningboard.workspace.g(),b.selector.bg.addClass("selector-part"),b.selector.lowergroup=b.drawningboard.workspace.g(),b.selector.lowergroup.addClass("selector-part"),b.selector.uppergroup=b.drawningboard.workspace.g(),b.selector.uppergroup.addClass("selector-part"),b.selector.multigroup=b.drawningboard.workspace.g(),b.selector.multigroup.addClass("selector-part"),b.selector.multiarea=b.selector.multigroup.rect(0,0,0,0),b.selector.highlightgroup=b.drawningboard.workspace.g(),b.selector.highlight=b.selector.highlightgroup.rect(0,0,0,0),b.multicoords,b.scalex=1,b.scaley=1,b.x=0,b.y=0,b.rotation=0,b.reshapeheight=0,b.dragging=!1,b.scaling=!1,b.rotating=!1,b.reshaping=!1,b.contextaction=!1,b.explodedmode=!1,b.deleting=!1,b.hovering=!1,b.selected=!1,b.multiselection=!1,b.displaycontrols=!0,b.moveselected=!1,b.lastclick=new Date,b.rotate,b.relativeset=0,b.selectionborderw=5,b.selectionborderh=5,b.pixellimit=40,b.changed=0,b.unselectimer,b.contentcolor="#2390BB",b.fillcolor="rgba(255, 255, 255, 0)",b.bgfillcolor="rgba(255, 255, 255, 0)",b.cornersfillcolor="rgba(255, 255, 255, 1)",b.multifillcolor="rgba(168, 202, 236, 0.5)",b.highlightcolor="rgba(255, 136, 0, 0.1)",b.highlightbordercolor="rgb(255, 136, 0)",b.curvedfillcolor="rgba(255, 0, 0, 1)",b.bordercolor="#2390BB",b.multibordercolor="#3399FF",b.rotateimage="img/Rotate-big.svg",b.strokestyle=2,b.multistrokestyle=1,b.cornerssize=b.drawningboard.isIOS?10:7,b.debug=!1,b.debugger=[],b.copytarget=[],b.colorcopytarget,b.pastecount,b.rotatetip=$('<div class="rotatetip" ><div lang_title="selector_rotate_title"></div></div>'),b.start=function(){b.startelements(),b.backwatch()},b.finish=function(){b.selector.lowergroup.clear(),b.selector.uppergroup.clear()},b.startelements=function(){b.selector.base=b.selector.lowergroup.rect(0,0,0,0).attr({fill:b.fillcolor,cursor:"move"}),b.selector.border=b.selector.uppergroup.rect(0,0,0,0).attr({fill:"none","stroke-width":b.strokestyle,stroke:b.bordercolor}),b.selector.highlight.attr({fill:b.highlightcolor,"stroke-width":b.multistrokestyle,stroke:b.highlightbordercolor}),b.selector.rotate=b.selector.uppergroup.g(),b.selector.rotate.attr({transform:"scale(0.5, 0.5)"}),b.selector.rotateline=b.selector.uppergroup.rect(100,-21,1,21).attr({fill:b.fillcolor,"stroke-width":1,stroke:b.bordercolor,cursor:"pointer"}),Snap.load(b.rotateimage,function(a){b.selector.rotate.add(a.select("svg")),b.selector.rotate.selectAll("path").attr({fill:b.contentcolor}),b.selector.rotate.select("svg").attr({y:"-71px",cursor:"pointer",x:0}),b.selector.rotate.select("svg").circle(14.5,0,15).attr({fill:"transparent"})}),b.selector.circle_se=b.selector.uppergroup.circle(0,0,0),b.selector.circle_se.name="se",b.selector.circle_se.number="4",b.selector.circle_se.type="corner",b.selector.circle_se.affectedby="regular",b.selector.circle_se.angle=135,b.selector.circle_se.xfactor=1,b.selector.circle_se.yfactor=1,b.selector.circle_sw=b.selector.uppergroup.circle(0,0,0),b.selector.circle_sw.name="sw",b.selector.circle_sw.number="2",b.selector.circle_sw.type="corner",b.selector.circle_sw.affectedby="regular",b.selector.circle_sw.angle=225,b.selector.circle_sw.xfactor=0,b.selector.circle_sw.yfactor=1,b.selector.circle_ne=b.selector.uppergroup.circle(0,0,0),b.selector.circle_ne.name="ne",b.selector.circle_ne.number="3",b.selector.circle_ne.type="corner",b.selector.circle_ne.affectedby="regular",b.selector.circle_ne.angle=45,b.selector.circle_ne.xfactor=1,b.selector.circle_ne.yfactor=0,b.selector.circle_nw=b.selector.uppergroup.circle(0,0,0),b.selector.circle_nw.name="nw",b.selector.circle_nw.number="1",b.selector.circle_nw.type="corner",b.selector.circle_nw.affectedby="regular",b.selector.circle_nw.angle=315,b.selector.circle_nw.xfactor=0,b.selector.circle_nw.yfactor=0,b.selector.circle_s=b.selector.uppergroup.circle(0,0,0),b.selector.circle_s.name="s",b.selector.circle_s.number="5",b.selector.circle_s.type="vertical",b.selector.circle_s.affectedby="vertical",b.selector.circle_s.angle=180,b.selector.circle_s.xfactor=.5,b.selector.circle_s.yfactor=1,b.selector.circle_n=b.selector.uppergroup.circle(0,0,0),b.selector.circle_n.name="n",b.selector.circle_n.number="6",b.selector.circle_n.type="vertical",b.selector.circle_n.affectedby="vertical",b.selector.circle_n.angle=0,b.selector.circle_n.xfactor=.5,b.selector.circle_n.yfactor=0,b.selector.circle_w=b.selector.uppergroup.circle(0,0,0),b.selector.circle_w.name="w",b.selector.circle_w.number="7",b.selector.circle_w.type="horizontal",b.selector.circle_w.affectedby="horizontal",b.selector.circle_w.angle=270,b.selector.circle_w.xfactor=0,b.selector.circle_w.yfactor=.5,b.selector.circle_e=b.selector.uppergroup.circle(0,0,0),b.selector.circle_e.name="e",b.selector.circle_e.number="8",b.selector.circle_e.type="horizontal",b.selector.circle_e.affectedby="horizontal",b.selector.circle_e.angle=90,b.selector.circle_e.xfactor=1,b.selector.circle_e.yfactor=.5,$.each([b.selector.circle_se,b.selector.circle_sw,b.selector.circle_ne,b.selector.circle_nw,b.selector.circle_s,b.selector.circle_n,b.selector.circle_w,b.selector.circle_e],function(a,c){c.attr({fill:b.cornersfillcolor,"stroke-width":b.strokestyle,stroke:b.bordercolor})}),b.selector.path=b.selector.uppergroup.path(),b.selector.path.attr({"stroke-width":3,stroke:b.curvedfillcolor,fill:"none"}),b.selector.curvedpathleft=b.selector.uppergroup.line(0,0,0,0).attr({fill:b.fillcolor,"stroke-width":1,stroke:b.bordercolor}),b.selector.curvedpathright=b.selector.uppergroup.line(0,0,0,0).attr({fill:b.fillcolor,"stroke-width":1,stroke:b.bordercolor}),b.selector.curvedleft=b.selector.uppergroup.circle(0,0,0),b.selector.curvedleft.name="left",b.selector.curvedanchorleft=b.selector.uppergroup.circle(0,0,0),b.selector.curvedanchorleft.name="anchorleft",b.selector.curvedanchorright=b.selector.uppergroup.circle(0,0,0),b.selector.curvedanchorright.name="anchorright",b.selector.curvedright=b.selector.uppergroup.circle(0,0,0),b.selector.curvedright.name="right",$.each([b.selector.curvedleft,b.selector.curvedright,b.selector.curvedanchorleft,b.selector.curvedanchorright],function(a,c){c.attr({fill:b.curvedfillcolor,"stroke-width":b.strokestyle,stroke:b.bordercolor,cursor:"pointer"})}),b.selector.curvedanchorleft.attr("fill","orange"),b.selector.curvedanchorright.attr("fill","orange"),b.selector.multiarea.attr({fill:b.multifillcolor,"stroke-width":b.multistrokestyle,stroke:b.multibordercolor}),b.selector.background=b.selector.bg.rect(0,0,b.drawningboard.width,b.drawningboard.height),b.selector.background.attr({fill:b.bgfillcolor}),$(b.selector.background.node).css({transition:"0.6s","-webkit-transition":"0.6s","-moz-transition":"0.6s","-0-transition":"0.6s"}),b.selector.context=b.selector.uppergroup.g(),b.selector.contextbuttom=b.selector.context.rect(0,0,30,30),b.selector.context.attr({cursor:"pointer",visibility:"hidden"}),b.selector.contextbuttom.attr({fill:b.contentcolor,rx:5,ry:5}),b.selector.context.rect(6,6,18,4).attr({fill:"white"}),b.selector.context.rect(6,13,18,4).attr({fill:"white"}),b.selector.context.rect(6,20,18,4).attr({fill:"white"}),b.debug&&(b.debugger.d1=b.drawningboard.workspace.circle(0,0,7),b.debugger.d2=b.drawningboard.workspace.circle(0,0,7),b.debugger.d3=b.drawningboard.workspace.circle(0,0,7),b.debugger.d4=b.drawningboard.workspace.circle(0,0,7),b.debugger.d5=b.drawningboard.workspace.circle(0,0,7),b.debugger.d1t=b.drawningboard.workspace.text(0,0,"d1"),b.debugger.d2t=b.drawningboard.workspace.text(0,0,"d2"),b.debugger.d3t=b.drawningboard.workspace.text(0,0,"d3"),b.debugger.d4t=b.drawningboard.workspace.text(0,0,"d4"),b.debugger.d5t=b.drawningboard.workspace.text(0,0,"d5"))},b.debug1=function(a,c,d){b.debugger.d1.attr({cx:a,cy:c,fill:"red"}),b.debugger.d1t.attr({x:a,y:c,fill:"red",stroke:"black","stroke-width":2}),b.debugger.d1t.node.textContent=d,b.drawningboard.workspace.add(b.debugger.d1),b.drawningboard.workspace.add(b.debugger.d1t)},b.debug2=function(a,c,d){b.debugger.d2.attr({cx:a,cy:c,fill:"blue"}),b.debugger.d2t.attr({x:a,y:c,fill:"blue",stroke:"black","stroke-width":2}),b.debugger.d2t.node.textContent=d,b.drawningboard.workspace.add(b.debugger.d2),b.drawningboard.workspace.add(b.debugger.d2t)},b.debug3=function(a,c,d){b.debugger.d3.attr({cx:a,cy:c,fill:"green"}),b.debugger.d3t.attr({x:a,y:c,fill:"green",stroke:"black","stroke-width":2}),b.debugger.d3t.node.textContent=d,b.drawningboard.workspace.add(b.debugger.d3),b.drawningboard.workspace.add(b.debugger.d3t)},b.debug4=function(a,c,d){b.debugger.d4.attr({cx:a,cy:c,fill:"yellow"}),b.debugger.d4t.attr({x:a,y:c,fill:"yellow",stroke:"black","stroke-width":2}),b.debugger.d4t.node.textContent=d,b.drawningboard.workspace.add(b.debugger.d4),b.drawningboard.workspace.add(b.debugger.d4t)},b.debug5=function(a,c,d){b.debugger.d5.attr({cx:a,cy:c,fill:"pink"}),b.debugger.d5t.attr({x:a,y:c,fill:"pink",stroke:"black","stroke-width":2}),b.debugger.d5t.node.textContent=d,b.drawningboard.workspace.add(b.debugger.d5),b.drawningboard.workspace.add(b.debugger.d5t)},b.update=function(){b.multiselection?(b.updateselector(!1),b.updatemultiselector(!0),b.drawningboard.informationtab.update()):b.target.length>0?(b.updatemultiselector(!1),b.updateselector(!0),b.drawningboard.informationtab.update()):(b.updatemultiselector(!1),b.updateselector(!1))},b.updatemultiselector=function(a){b.selector.multiarea.attr(a?{x:b.x,y:b.y,width:b.width,height:b.height}:{width:0,height:0})},b.updateselector=function(a){a?(b.selector.lowergroup.attr({transform:"translate("+parseInt(b.x-b.width/2)+","+parseInt(b.y-b.height/2)+") rotate("+calc.fixDegree(b.rotation)+" "+b.width/2+" "+b.height/2+") "}),b.selector.uppergroup.attr({transform:"translate("+parseInt(b.x-b.width/2)+","+parseInt(b.y-b.height/2)+") rotate("+calc.fixDegree(b.rotation)+" "+b.width/2+" "+b.height/2+") "}),b.reshaping||(b.selector.base.attr({width:b.width+"px",height:b.height+"px"}),b.selector.border.attr({width:b.width+"px",height:b.height+"px"})),b.selected&&!b.reshaping&&(b.drawningboard.ownermode&&b.drawningboard.selector.targethavecompanytext()||(b.selector.rotate.select("svg").attr({x:2*(b.width/2-7.25)}),b.selector.rotate.selectAll("path").attr({fill:"#2390BB"}),b.selector.rotateline.attr({x:b.width/2,width:1}))),b.selected&&1==b.target.length&&b.target[0]instanceof Text&&b.target[0].curvedline.enabled&&!b.scaling?(b.selector.curvedleft.attr({cx:b.selector.curvedleft.x,cy:b.selector.curvedleft.y,r:b.cornerssize}),b.selector.curvedanchorleft.attr({cx:b.selector.curvedanchorleft.x,cy:b.selector.curvedanchorleft.y,r:b.cornerssize}),b.selector.curvedanchorright.attr({cx:b.selector.curvedanchorright.x,cy:b.selector.curvedanchorright.y,r:b.cornerssize}),b.selector.curvedright.attr({cx:b.selector.curvedright.x,cy:b.selector.curvedright.y,r:b.cornerssize}),b.selector.path.attr({d:"M"+b.selector.curvedleft.attr("cx")+","+b.selector.curvedleft.attr("cy")+" C"+b.selector.curvedanchorleft.attr("cx")+","+b.selector.curvedanchorleft.attr("cy")+" "+b.selector.curvedanchorright.attr("cx")+","+b.selector.curvedanchorright.attr("cy")+" "+b.selector.curvedright.attr("cx")+","+b.selector.curvedright.attr("cy")}),b.selector.curvedpathleft.attr({x1:b.selector.curvedleft.attr("cx"),y1:b.selector.curvedleft.attr("cy"),x2:b.selector.curvedanchorleft.attr("cx"),y2:b.selector.curvedanchorleft.attr("cy")}),b.selector.curvedpathright.attr({x1:b.selector.curvedright.attr("cx"),y1:b.selector.curvedright.attr("cy"),x2:b.selector.curvedanchorright.attr("cx"),y2:b.selector.curvedanchorright.attr("cy")})):b.scaling&&($.each([b.selector.curvedleft,b.selector.curvedanchorleft,b.selector.curvedanchorright,b.selector.curvedright],function(a,b){b.attr({r:0})}),b.selector.path.attr({d:""}),b.selector.curvedpathleft.attr({x1:0,y1:0,x2:0,y2:0}),b.selector.curvedpathright.attr({x1:0,y1:0,x2:0,y2:0})),b.displaycontrols&&!b.reshaping&&$.each([b.selector.circle_se,b.selector.circle_sw,b.selector.circle_ne,b.selector.circle_nw,b.selector.circle_s,b.selector.circle_n,b.selector.circle_w,b.selector.circle_e],function(a,c){c.attr({cx:Math.ceil(b.width*c.xfactor),cy:Math.ceil(b.height*c.yfactor),r:b.cornerssize})}),b.rotation>=45&&b.rotation<135?(b.selector.circle_se.attr({cursor:"sw-resize"}),b.selector.circle_sw.attr({cursor:"nw-resize"}),b.selector.circle_ne.attr({cursor:"se-resize"}),b.selector.circle_nw.attr({cursor:"ne-resize"}),b.selector.circle_se.affectedby="flipped",b.selector.circle_sw.affectedby="flipped",b.selector.circle_ne.affectedby="flipped",b.selector.circle_nw.affectedby="flipped",b.selector.circle_n.attr({cursor:"e-resize"}),b.selector.circle_s.attr({cursor:"w-resize"}),b.selector.circle_w.attr({cursor:"n-resize"}),b.selector.circle_e.attr({cursor:"s-resize"}),b.selector.circle_n.affectedby="horizontal",b.selector.circle_s.affectedby="horizontal",b.selector.circle_w.affectedby="vertical",b.selector.circle_e.affectedby="vertical"):b.rotation>=135&&b.rotation<225?(b.selector.circle_se.attr({cursor:"nw-resize"}),b.selector.circle_sw.attr({cursor:"ne-resize"}),b.selector.circle_ne.attr({cursor:"sw-resize"}),b.selector.circle_nw.attr({cursor:"se-resize"}),b.selector.circle_se.affectedby="regular",b.selector.circle_sw.affectedby="regular",b.selector.circle_ne.affectedby="regular",b.selector.circle_nw.affectedby="regular",b.selector.circle_n.attr({cursor:"s-resize"}),b.selector.circle_s.attr({cursor:"n-resize"}),b.selector.circle_w.attr({cursor:"e-resize"}),b.selector.circle_e.attr({cursor:"w-resize"}),b.selector.circle_n.affectedby="vertical",b.selector.circle_s.affectedby="vertical",b.selector.circle_w.affectedby="horizontal",b.selector.circle_e.affectedby="horizontal"):b.rotation>=225&&b.rotation<315?(b.selector.circle_se.attr({cursor:"ne-resize"}),b.selector.circle_sw.attr({cursor:"se-resize"}),b.selector.circle_ne.attr({cursor:"nw-resize"}),b.selector.circle_nw.attr({cursor:"sw-resize"}),b.selector.circle_se.affectedby="flipped",b.selector.circle_sw.affectedby="flipped",b.selector.circle_ne.affectedby="flipped",b.selector.circle_nw.affectedby="flipped",b.selector.circle_n.attr({cursor:"w-resize"}),b.selector.circle_s.attr({cursor:"e-resize"}),b.selector.circle_w.attr({cursor:"s-resize"}),b.selector.circle_e.attr({cursor:"n-resize"}),b.selector.circle_n.affectedby="horizontal",b.selector.circle_s.affectedby="horizontal",b.selector.circle_w.affectedby="vertical",b.selector.circle_e.affectedby="vertical"):(b.selector.circle_se.attr({cursor:"se-resize"}),b.selector.circle_sw.attr({cursor:"sw-resize"}),b.selector.circle_ne.attr({cursor:"ne-resize"}),b.selector.circle_nw.attr({cursor:"nw-resize"}),b.selector.circle_se.affectedby="regular",b.selector.circle_sw.affectedby="regular",b.selector.circle_ne.affectedby="regular",b.selector.circle_nw.affectedby="regular",b.selector.circle_n.attr({cursor:"n-resize"}),b.selector.circle_s.attr({cursor:"s-resize"}),b.selector.circle_w.attr({cursor:"w-resize"}),b.selector.circle_e.attr({cursor:"e-resize"}),b.selector.circle_n.affectedby="vertical",b.selector.circle_s.affectedby="vertical",b.selector.circle_w.affectedby="horizontal",b.selector.circle_e.affectedby="horizontal"),b.drawningboard.workspace.add(b.selector.uppergroup)):(b.selector.base.attr({width:0,height:0}),b.selector.border.attr({width:0,height:0}),b.selector.context.attr({transform:"translate("+(b.width-50)+",-15)",opacity:0}),b.selector.rotate.selectAll("path").attr({fill:"transparent"}),b.selector.rotateline.attr({width:0}),$.each([b.selector.circle_se,b.selector.circle_sw,b.selector.circle_ne,b.selector.circle_nw,b.selector.circle_s,b.selector.circle_n,b.selector.circle_w,b.selector.circle_e,b.selector.curvedleft,b.selector.curvedanchorleft,b.selector.curvedanchorright,b.selector.curvedright],function(a,b){b.attr({r:0})}),b.selector.path.attr({d:""}),b.selector.curvedpathleft.attr({x1:0,y1:0,x2:0,y2:0}),b.selector.curvedpathright.attr({x1:0,y1:0,x2:0,y2:0}))},b.highlight=function(a){var c=b.getclipdata(a);b.selector.highlight.attr({x:c.x1,y:c.y1,width:c.width,height:c.height})},b.unhighlight=function(){b.selector.highlight.attr({width:0,height:0})},b.select=function(a,c){b.unhighlight(),b.multiselection||(clearTimeout(b.unselectimer),b.unselect(),b.target=a,c&&(b.selected=c,b.drawningboard.contexttab.select(a),b.drawningboard.informationtab.select(a),b.drawningboard.alignbar.select(a)),b.gettargetdata(),b.update())},b.save=function(){b.relativeset=0,1==b.changed&&(b.changed=0,b.drawningboard.flowtab.pushstate())},b.unselect=function(){b.drawningboard.contexttab.select(null),b.drawningboard.informationtab.select(null),b.drawningboard.alignbar.select(null),b.selected=!1,b.hovering=!1,b.relativeset=0,$.each(b.target,function(a,b){b.update()}),b.target=[],b.x=0,b.y=0,b.width=0,b.height=0,b.rotation=0,b.closetips(),b.closecontext(),b.updatemultiselector(!1),b.updateselector(!1)},b.startexplodedmode=function(a){b.explodedmode=!0,b.explodedtarget=[],b.selector.background.attr({fill:"rgba(255,255,255,0.8)"}),b.drawningboard.toolbar.disable(),$.each(b.retrievegroupelements(a),function(a,c){c.bg&&c.bg.attr({width:0,height:0}),b.drawningboard.workspace.add(c.group),b.explodedtarget.push(c)});var c=b.target[0];b.unselect(),void 0==a?(b.target=[c],b.select(b.target,!0)):(b.target=[a],b.select(b.target,!0)),b.refreshindex()},b.redrawbg=function(){b.selector.background.attr({width:b.drawningboard.width,height:b.drawningboard.height})},b.endexplodedmode=function(){b.explodedmode&&(b.explodedmode=!1,b.selector.background.attr({fill:b.bgfillcolor}),b.drawningboard.toolbar.enable(),$.each(b.drawningboard.cliplist,function(a,b){b.bg&&b.bg.attr({width:b.width,height:b.height})}),b.refreshindex())},b.targethavecompanytext=function(){var a=!1;return $.each(b.target,function(b,c){c.companytext&&(a=!0)}),a},b.targetisgroup=function(a){var c=!0,d=void 0;return a?a instanceof Array||(a=[a]):a=b.target,b.retrievegroupelements(a[0]).length<2&&(c=!1),$.each(a,function(a,b){void 0==d?d=b.groupid:b.groupid!=d&&(c=!1)}),c},b.targetisicon=function(a){var c=!0,d=void 0;return a?a instanceof Array||(a=[a]):a=b.target,b.retrieveiconelements(a[0]).length<2&&(c=!1),$.each(a,function(a,b){void 0==d?d=b.id:b.id!=d&&(c=!1)}),c},b.clipisicon=function(a){return b.retrieveiconelements(a).length>1?!0:!1},b.clipisgroup=function(a){return b.retrievegroupelements(a).length>1?!0:!1},b.closetips=function(){$(".rotatetip").remove()},b.closecontext=function(){b.contextmenu&&b.contextmenu.finish()},b.checkoverlap=function(a){if(b.clipisgroup(a)&&!b.explodedmode)var c=b.getgroupcoords(a);else var c=b.getrotatedcoords(a);var d=calc.valueInRange(b.x,c.x1,c.x4)||calc.valueInRange(b.x+b.width,c.x1,c.x4)||calc.valueInRange(c.x1,b.x,b.x+b.width)||calc.valueInRange(c.x4,b.x,b.x+b.width),e=calc.valueInRange(b.y,c.y1,c.y4)||calc.valueInRange(b.y+b.height,c.y1,c.y4)||calc.valueInRange(c.y1,b.y,b.y+b.height)||calc.valueInRange(c.y4,b.y,b.y+b.height),f=a.alpha>0;return d&&e&&f&&0!=b.x&&0!=b.y},b.getcoords=function(a){var b={x1:a.x-a.width*a.scalex*.5,y1:a.y-a.height*a.scaley*.5,x2:a.x-a.width*a.scalex*.5,y2:a.y+a.height*a.scaley*.5,x3:a.x+a.width*a.scalex*.5,y3:a.y-a.height*a.scaley*.5,x4:a.x+a.width*a.scalex*.5,y4:a.y+a.height*a.scaley*.5,xc:a.x,yc:a.y};return b},b.getgroupcoords=function(a){var c=b.drawningboard.width,d=b.drawningboard.height,e=0,f=0;$.each(b.retrievegroupelements(a),function(a,g){var h=b.getrotatedcoords(g),i=[];i.push({x:h.x1,y:h.y1}),i.push({x:h.x2,y:h.y2}),i.push({x:h.x3,y:h.y3}),i.push({x:h.x4,y:h.y4}),$.each(i,function(a,b){b.x<c&&(c=b.x),b.y<d&&(d=b.y),b.x>e&&(e=b.x),b.y>f&&(f=b.y)})});var g={x1:c,y1:d,x2:c,y2:f,x3:e,y3:d,x4:e,y4:f,xc:c+(e-c)/2,yc:d+(f-d)/2};return g},b.geticoncoords=function(a){var c=b.drawningboard.width,d=b.drawningboard.height,e=0,f=0;$.each(b.retrieveiconelements(a),function(a,g){var h=b.getrotatedcoords(g),i=[];i.push({x:h.x1,y:h.y1}),i.push({x:h.x2,y:h.y2}),i.push({x:h.x3,y:h.y3}),i.push({x:h.x4,y:h.y4}),$.each(i,function(a,b){b.x<c&&(c=b.x),b.y<d&&(d=b.y),b.x>e&&(e=b.x),b.y>f&&(f=b.y)})});var g={x1:c,y1:d,x2:c,y2:f,x3:e,y3:d,x4:e,y4:f,xc:c+(e-c)/2,yc:d+(f-d)/2};return g},b.getrotatedcoords=function(a){var c=b.getcoords(a),d=calc.rotatePoint(c.x1,c.y1,a.x,a.y,-a.rotation),e=calc.rotatePoint(c.x2,c.y2,a.x,a.y,-a.rotation),f=calc.rotatePoint(c.x3,c.y3,a.x,a.y,-a.rotation),g=calc.rotatePoint(c.x4,c.y4,a.x,a.y,-a.rotation),h={x1:d.x,y1:d.y,x2:e.x,y2:e.y,x3:f.x,y3:f.y,x4:g.x,y4:g.y,xc:c.xc,yc:c.yc};return h},b.getselfrotatedcoords=function(a){var c=b.getcoords(a),d=calc.rotatePoint(c.x1,c.y1,a.x,a.y,-a.rotation),e=calc.rotatePoint(c.x2,c.y2,a.x,a.y,-a.rotation),f=calc.rotatePoint(c.x3,c.y3,a.x,a.y,-a.rotation),g=calc.rotatePoint(c.x4,c.y4,a.x,a.y,-a.rotation),d=calc.rotatePoint(d.x,d.y,b.x,b.y,+b.rotation),e=calc.rotatePoint(e.x,e.y,b.x,b.y,+b.rotation),f=calc.rotatePoint(f.x,f.y,b.x,b.y,+b.rotation),g=calc.rotatePoint(g.x,g.y,b.x,b.y,+b.rotation),h={x1:d.x,y1:d.y,x2:e.x,y2:e.y,x3:f.x,y3:f.y,x4:g.x,y4:g.y};return h},b.updateselectionborder=function(){if(1==b.target.length)b.target[0]instanceof Text?(b.selectionborderw=0,b.selectionbordery=0):b.selectionborderw=5;else{var a=!1,c=.5;$.each(b.target,function(b,d){d instanceof Text&&(a=!0,d.scalex>c&&(c=d.scalex))}),a?(b.selectionborderw=0,b.selectionbordery=0):b.selectionborderw=5}},b.gettargetdata=function(){if(b.updateselectionborder(),1==b.target.length){b.rotation=b.target[0].rotation;var a=b.getsingleclipdata(b.target)}else var a=b.getclipdata(b.target);b.updateselectionborder(),b.width=a.width+2*b.selectionborderw,b.height=a.height+2*b.selectionborderh,b.x=a.x,b.y=a.y,1==b.target.length&&b.target[0]instanceof Text&&b.getcurveddata()},b.gettargetscaledata=function(){var a=b.drawningboard.width,c=b.drawningboard.height,d=0,e=0;$.each(b.target,function(f,g){var h=b.getselfrotatedcoords(g),i=[];i.push({x:h.x1,y:h.y1}),i.push({x:h.x2,y:h.y2}),i.push({x:h.x3,y:h.y3}),i.push({x:h.x4,y:h.y4}),$.each(i,function(b,f){f.x<a&&(a=f.x),f.y<c&&(c=f.y),f.x>d&&(d=f.x),f.y>e&&(e=f.y)})}),b.updateselectionborder(),b.width=d-a+2*b.selectionborderw,b.height=e-c+2*b.selectionborderh,1==b.target.length&&b.target[0]instanceof Text&&b.getcurveddata()},b.getcurveddata=function(){var a=b.target[0];if(a.flipx||a.flipy)var c=calc.rotatePoint(a.curvedline.left.x,a.curvedline.left.y,a.width/2,a.height/2,-180),d=calc.rotatePoint(a.curvedline.anchorleft.x,a.curvedline.anchorleft.y,a.width/2,a.height/2,-180),e=calc.rotatePoint(a.curvedline.anchorright.x,a.curvedline.anchorright.y,a.width/2,a.height/2,-180),f=calc.rotatePoint(a.curvedline.right.x,a.curvedline.right.y,a.width/2,a.height/2,-180);a.flipx?(b.selector.curvedleft.x=c.x*a.scalex+b.selectionborderw,b.selector.curvedanchorleft.x=d.x*a.scalex+b.selectionborderw,b.selector.curvedanchorright.x=e.x*a.scalex+b.selectionborderw,b.selector.curvedright.x=f.x*a.scalex+b.selectionborderw):(b.selector.curvedleft.x=a.curvedline.left.x*a.scalex+b.selectionborderw,b.selector.curvedanchorleft.x=a.curvedline.anchorleft.x*a.scalex+b.selectionborderw,b.selector.curvedanchorright.x=a.curvedline.anchorright.x*a.scalex+b.selectionborderw,b.selector.curvedright.x=a.curvedline.right.x*a.scalex+b.selectionborderw),a.flipy?(b.selector.curvedleft.y=c.y*a.scaley+b.selectionborderh,b.selector.curvedanchorleft.y=d.y*a.scaley+b.selectionborderh,b.selector.curvedanchorright.y=e.y*a.scaley+b.selectionborderh,b.selector.curvedright.y=f.y*a.scaley+b.selectionborderh):(b.selector.curvedleft.y=a.curvedline.left.y*a.scaley+b.selectionborderh,b.selector.curvedanchorleft.y=a.curvedline.anchorleft.y*a.scaley+b.selectionborderh,b.selector.curvedanchorright.y=a.curvedline.anchorright.y*a.scaley+b.selectionborderh,b.selector.curvedright.y=a.curvedline.right.y*a.scaley+b.selectionborderh)},b.getsingleclipdata=function(a){var c=b.drawningboard.width,d=b.drawningboard.height,e=0,f=0;$.each(a,function(a,g){var h=b.getcoords(g),i=[];i.push({x:h.x1,y:h.y1}),i.push({x:h.x2,y:h.y2}),i.push({x:h.x3,y:h.y3}),i.push({x:h.x4,y:h.y4}),$.each(i,function(a,b){b.x<c&&(c=b.x),b.y<d&&(d=b.y),b.x>e&&(e=b.x),b.y>f&&(f=b.y)})});var g={width:parseInt(e-c),height:parseInt(f-d),x:parseInt(c+(e-c)/2),y:parseInt(d+(f-d)/2),x1:parseInt(c),y1:parseInt(d)};return g},b.getclipdata=function(a){var c=b.drawningboard.width,d=b.drawningboard.height,e=0,f=0;$.each(a,function(a,g){var h=b.getrotatedcoords(g),i=[];i.push({x:h.x1,y:h.y1}),i.push({x:h.x2,y:h.y2}),i.push({x:h.x3,y:h.y3}),i.push({x:h.x4,y:h.y4}),$.each(i,function(a,b){b.x<c&&(c=b.x),b.y<d&&(d=b.y),b.x>e&&(e=b.x),b.y>f&&(f=b.y)})});var g={width:parseInt(e-c),height:parseInt(f-d),x:parseInt(c+(e-c)/2),y:parseInt(d+(f-d)/2),x1:parseInt(c),y1:parseInt(d)};return g},b.selectall=function(){b.target=[],$.each(b.drawningboard.cliplist,function(a,c){c.enabled()&&b.target.push(c)}),b.rotation=0,b.select(b.target,1)},b.unsetoffset=function(){void 0!=b.target&&(b.target instanceof Array?$.each(b.target,function(a,b){b.offset.x=0,b.offset.y=0}):(b.target.offset.x=0,b.target.offset.y=0))},b.setoffset=function(a){b.offset=b.getoffset(b,a),$.each(b.target,function(c,d){d.offset=b.getoffset(d,a)})},b.workspacemove=function(a){var c=b.getclick(a);if(!b.contextaction&&!b.drawningboard.messagemenu)if(b.target.length>0&&b.dragging)b.settargetposition(b.target,c.x,c.y);else if(b.multiselection)b.multicoords.x2=c.x,b.multicoords.y2=c.y,b.width=Math.abs(b.multicoords.x2-b.multicoords.x1),b.height=Math.abs(b.multicoords.y2-b.multicoords.y1),b.x=b.multicoords.x2>b.multicoords.x1?b.multicoords.x1:b.multicoords.x2,b.y=b.multicoords.y2>b.multicoords.y1?b.multicoords.y1:b.multicoords.y2,b.update();else if(b.scaling){b.selected=!0;var d=b.x,e=b.y,f=b.width,g=b.height,h=calc.rotatePoint(b.relativemeasures.resizerelopx,b.relativemeasures.resizerelopy,b.relativemeasures.xc,b.relativemeasures.yc,b.rotation),i=calc.rotatePoint(c.x,c.y,b.relativemeasures.xc,b.relativemeasures.yc,b.rotation),j=calc.getDistance(i.x,i.y,h.x,h.y),k=Math.ceil(Math.abs(i.x-h.x)),l=Math.ceil(Math.abs(i.y-h.y)),m=j/(2*b.relativemeasures.distance),n=k/b.relativemeasures.width,o=l/b.relativemeasures.height,p=!0,q=!0,r=!0;if("corner"==b.relativemeasures.resize.type?(a.shiftKey||(n=m,o=m),f=Math.ceil(b.relativemeasures.width*n),g=Math.ceil(b.relativemeasures.height*o),"nw"==b.relativemeasures.resize.name?(d=b.relativemeasures.resizeopx-f/2,e=b.relativemeasures.resizeopy-g/2,a.shiftKey?(i.x>b.relativemeasures.resizeopx||i.y>b.relativemeasures.resizeopy)&&(p=!1):i.x>b.relativemeasures.resizeopx&&i.y>b.relativemeasures.resizeopy&&(p=!1)):"sw"==b.relativemeasures.resize.name?(d=b.relativemeasures.resizeopx-f/2,e=b.relativemeasures.resizeopy+g/2,a.shiftKey?(i.x>b.relativemeasures.resizeopx||i.y<b.relativemeasures.resizeopy)&&(p=!1):i.x>b.relativemeasures.resizeopx&&i.y<b.relativemeasures.resizeopy&&(p=!1)):"ne"==b.relativemeasures.resize.name?(d=b.relativemeasures.resizeopx+f/2,e=b.relativemeasures.resizeopy-g/2,a.shiftKey?(i.x<b.relativemeasures.resizeopx||i.y>b.relativemeasures.resizeopy)&&(p=!1):i.x<b.relativemeasures.resizeopx&&i.y>b.relativemeasures.resizeopy&&(p=!1)):"se"==b.relativemeasures.resize.name&&(d=b.relativemeasures.resizeopx+f/2,e=b.relativemeasures.resizeopy+g/2,a.shiftKey?(i.x<b.relativemeasures.resizeopx||i.y<b.relativemeasures.resizeopy)&&(p=!1):i.x<b.relativemeasures.resizeopx&&i.y<b.relativemeasures.resizeopy&&(p=!1))):"horizontal"==b.relativemeasures.resize.type?(f=Math.ceil(b.relativemeasures.width*n),q=!1,e=b.relativemeasures.resizeopy,"w"==b.relativemeasures.resize.name?(d=b.relativemeasures.resizeopx-f/2,i.x>b.relativemeasures.resizeopx&&(p=!1)):"e"==b.relativemeasures.resize.name&&(d=b.relativemeasures.resizeopx+f/2,i.x<b.relativemeasures.resizeopx&&(p=!1))):"vertical"==b.relativemeasures.resize.type&&(g=Math.ceil(b.relativemeasures.height*o),r=!1,d=b.relativemeasures.resizeopx,"n"==b.relativemeasures.resize.name?(e=b.relativemeasures.resizeopy-g/2,i.y>b.relativemeasures.resizeopy&&(p=!1)):"s"==b.relativemeasures.resize.name&&(e=b.relativemeasures.resizeopy+g/2,i.y<b.relativemeasures.resizeopy&&(p=!1))),(f!=b.width||g!=b.height)&&g>20&&f>20&&p){if(0!=b.rotation){var s=calc.rotatePoint(d,e,b.relativemeasures.xc,b.relativemeasures.yc,-b.rotation);b.x=Math.ceil(s.x),b.y=Math.ceil(s.y)}else b.x=d,b.y=e;b.width=f,b.height=g,b.update(),b.changed=1,$.each(b.target,function(a,c){r?(c.scalex=c.relativemeasures.scalex*n,c.x=b.x-c.relativemeasures.offx*n):c.x=b.x-c.relativemeasures.offx,q?(c.scaley=c.relativemeasures.scaley*o,c.y=b.y-c.relativemeasures.offy*o):c.y=b.y-c.relativemeasures.offy,c.update()})}}else if(b.rotating){var t=calc.getDegree(calc.getRadian(b.x,b.y,c.x,c.y));b.settargetrotation(t),b.closetips()}else if(b.reshaping){var u=b.target[0],v=b.getrelativemeasures(a,b);b.relativemeasures.resize.x=b.width/2-v.curvedx,b.relativemeasures.resize.y=b.height/2-v.curvedy;var d=b.relativemeasures.resize.x/u.scalex-b.selectionborderw,e=b.relativemeasures.resize.y/u.scaley-b.selectionborderh;if(u.flipx||u.flipy){var w=calc.rotatePoint(d,e,u.width/2,u.height/2,-180);u.flipx&&(d=w.x),u.flipy&&(e=w.y)}"anchorright"==b.relativemeasures.resize.name?(u.curvedline.anchorright.x=d,u.curvedline.anchorright.y=e):"anchorleft"==b.relativemeasures.resize.name?(u.curvedline.anchorleft.x=d,u.curvedline.anchorleft.y=e):"right"==b.relativemeasures.resize.name?(u.curvedline.right.x=d,u.curvedline.right.y=e):"left"==b.relativemeasures.resize.name&&(u.curvedline.left.x=d,u.curvedline.left.y=e),b.update(),u.curvedline.enabled=!0,u.curvedline.start=!0,u.update(),b.drawningboard.contexttab.updatepreview()}},b.workspacerelease=function(){if(b.update(),b.unsetoffset(),b.dragging=!1,b.drawningboard.workspace.attr({cursor:"auto"}),b.multiselection){if(b.multiselection=!1,b.target=[],b.explodedmode)var a=b.explodedtarget;else var a=b.drawningboard.cliplist;$.each(a,function(a,c){b.checkoverlap(c)&&b.includetarget(c)}),b.target.length>0?b.select(b.target,1):b.unselect()}else if(b.scaling)b.scaling=!1,b.endtransform(),b.select(b.target,1);else if(b.rotating)b.rotating=!1,b.endtransform();else if(b.reshaping){var c=b.target[0];b.reshaperelease();var d=c.x,e=c.y;b.reshaperelease(),c.x=d,c.y=e,c.update(),b.gettargetdata(),b.update(),b.changed=1,b.drawningboard.contexttab.updatepreview()}b.save()},b.reshaperelease=function(){var a=b.target[0],c=a.svg.getBBox(),d=a.group.getBBox(),e=c.x,f=c.x2,g=c.y,h=c.y2;$.each([a.curvedline.left.x,a.curvedline.anchorleft.x,a.curvedline.anchorright.x,a.curvedline.right.x],function(a,b){e>b&&(e=b),b>f&&(f=b)}),$.each([a.curvedline.left.y,a.curvedline.anchorleft.y,a.curvedline.anchorright.y,a.curvedline.right.y],function(a,b){g>b&&(g=b),b>h&&(h=b)});var i=f-e,j=h-g;if(a.flipx)var k=(a.x-d.cx)/a.scalex;else var k=(d.cx-a.x)/a.scalex;if(a.flipy)var l=(a.y-d.cy)/a.scaley;else var l=(d.cy-a.y)/a.scaley;a.curvedline.left.x-=k,a.curvedline.anchorleft.x-=k,a.curvedline.anchorright.x-=k,a.curvedline.right.x-=k,a.curvedline.left.y-=l,a.curvedline.anchorleft.y-=l,a.curvedline.anchorright.y-=l,a.curvedline.right.y-=l,a.x=d.cx,a.y=d.cy,a.width=i,a.height=j,a.update(),b.update(),b.reshaping=!1},b.contextrelease=function(){b.contextaction&&(b.contextaction=!1,b.update(),b.unsetoffset(),b.scalex=1,b.scaley=1,b.scaling?b.scaling=!1:b.rotating?b.rotating=!1:b.reshaping&&(b.reshaping=!1),b.save())},b.clippress=function(a,c){if(2==c.button)return-1!=b.target.indexOf(a)&&b.selected||(b.settarget(a),b.select(b.target,1)),void b.contextpress(c);c.preventDefault?c.preventDefault():c.returnValue=!1;var d=new Date;d-b.lastclick<300&&b.targetisgroup(a)?b.startexplodedmode(a):(-1!=b.target.indexOf(a)?c.ctrlKey?(b.excludetarget(a),b.select(b.target,1)):b.selected||b.select(b.target,1):c.ctrlKey?(b.includetarget(a),b.select(b.target,1)):(b.settarget(a),b.select(b.target,1)),b.setoffset(c),b.dragging=!0),b.lastclick=d},b.backgroundpress=function(a){setTimeout(function(){var c=new Date;if(c-b.lastclick<300)b.explodedmode&&b.endexplodedmode();else{var d=b.getclick(a);b.multicoords={x1:d.x,y1:d.y,x2:d.x,y2:d.y},b.multiselection=!0,b.unselect()
}b.lastclick=c},1)},b.backgroundover=function(){b.unwatchtimer(),b.closetips()},b.selectorpress=function(a){if(2==a.button)return void b.contextpress(a);a.preventDefault?a.preventDefault():a.returnValue=!1;var c=new Date;c-b.lastclick<300&&b.targetisgroup(b.target[0])?b.startexplodedmode(b.target[0]):(b.setoffset(a),b.dragging=!0),b.lastclick=c},b.resizepress=function(a,c){b.closecontext(),b.gettargetscaledata(),b.starttransform(),b.relativemeasures=b.getrelativemeasures(c,b,a),$.each(b.target,function(a,d){d.relativemeasures=b.getrelativemeasures(c,d)}),b.setoffset(c),a&&b.drawningboard.workspace.attr({cursor:a.attr("cursor")}),b.scaling=!0},b.reshapepress=function(a,c){c&&(c.preventDefault?c.preventDefault():c.returnValue=!1),0!=b.target[0].rotation&&b.reshapesetrotation(),b.drawningboard.workspace.attr({cursor:"pointer"}),b.relativemeasures=b.getrelativemeasures(c,b,a),b.reshaping=!0,b.updateselector(!1),b.update(),b.drawningboard.contexttab.updatepreview()},b.reshapesetrotation=function(){var a=b.target[0],c=calc.rotatePoint(a.curvedline.left.x,a.curvedline.left.y,a.width/2,a.height/2,-a.rotation),d=calc.rotatePoint(a.curvedline.anchorleft.x,a.curvedline.anchorleft.y,a.width/2,a.height/2,-a.rotation),e=calc.rotatePoint(a.curvedline.anchorright.x,a.curvedline.anchorright.y,a.width/2,a.height/2,-a.rotation),f=calc.rotatePoint(a.curvedline.right.x,a.curvedline.right.y,a.width/2,a.height/2,-a.rotation);a.curvedline.left.x=c.x,a.curvedline.left.y=c.y,a.curvedline.anchorleft.x=d.x,a.curvedline.anchorleft.y=d.y,a.curvedline.anchorright.x=e.x,a.curvedline.anchorright.y=e.y,a.curvedline.right.x=f.x,a.curvedline.right.y=f.y,a.rotation=0,b.rotation=0,b.gettargetdata()},b.rotatehover=function(a){if(b.starttransform(),!b.rotating){var c=b.getclick(a);b.closetips();var d=b.drawningboard.api.fillTemplateLanguage(b.rotatetip);$("#drawningboard").append(d),d.css("left",c.x),d.css("top",c.y);var e=d.find("div");e.tooltip(),e.tooltip("open")}},b.rotatepress=function(a){b.drawningboard.workspace.attr({cursor:"pointer"}),b.relativemeasures=b.getrelativemeasures(a,b),$.each(b.target,function(c,d){d.relativemeasures=b.getrelativemeasures(a,d)}),b.rotating=!0},b.contextpress=function(a){var c=b.getclick(a);b.contextmenu=new Contextmenu(b.drawningboard),b.contextmenu.x=c.x,b.contextmenu.y=c.y,b.contextmenu.start()},b.watchcolors=function(a){$.each(a.color.colorlist,function(a,c){var d=stringToRgba(c.color);b.drawningboard.addrecentcolor(d)})},b.watch=function(a){b.drawningboard.cliplist.push(a),b.watchcolors(a),b.drawningboard.isTouch?a.group.touchstart(function(c){b.clippress(a,c)}):(a.group.mouseover(function(){!b.selected&&a.enabled()&&(b.settarget(a),b.select(b.target,0),b.hovering=!0)}),a.group.mousedown(function(c){b.clippress(a,c)})),b.createstatelist(a)},b.includetarget=function(a){0==a.groupid||b.explodedmode?b.target.push(a):b.target=arrayUnique(b.target.concat(b.retrievegroupelements(a)))},b.excludetarget=function(a){0==a.groupid||b.explodedmode?b.target.splice(b.target.indexOf(a),1):$.each(b.retrievegroupelements(a),function(a,c){b.target.splice(b.target.indexOf(c),1)})},b.settarget=function(a){b.target=0==a.groupid||b.explodedmode?0!=a.groupid?[a]:[a]:b.retrievegroupelements(a)},b.retrievegroupelements=function(a){var c=[];return a&&$.each(b.drawningboard.cliplist,function(b,d){d.enabled()&&0!=d.groupid&&d.groupid==a.groupid&&c.push(d)}),c},b.retrieveiconelements=function(a){var c=[];return a&&$.each(b.drawningboard.cliplist,function(b,d){d.iconname==a.iconname&&d.enabled()&&void 0!=d.subid&&c.push(d)}),c},b.retrieveotherelements=function(a){var c=[];return $.each(b.drawningboard.cliplist,function(b,d){(d.iconname!=a.iconname||void 0==a.iconname)&&c.push(d)}),c},b.backwatch=function(){b.drawningboard.isTouch?(b.selector.bg.touchstart(b.backgroundpress),b.drawningboard.workspace.untouchmove(b.workspacemove),b.drawningboard.workspace.untouchend(b.workspacerelease),b.drawningboard.workspace.touchmove(b.workspacemove),b.drawningboard.workspace.touchend(b.workspacerelease),b.selector.base.touchstart(b.selectorpress),$.each([b.selector.circle_se,b.selector.circle_sw,b.selector.circle_ne,b.selector.circle_nw,b.selector.circle_s,b.selector.circle_n,b.selector.circle_w,b.selector.circle_e],function(a,c){c.touchstart(function(a){b.resizepress(c,a)})}),b.selector.rotate.touchstart(b.rotatepress),$.each([b.selector.curvedleft,b.selector.curvedanchorleft,b.selector.curvedanchorright,b.selector.curvedright],function(a,c){c.touchstart(function(a){b.reshapepress(c,a)})})):(b.selector.bg.mousedown(b.backgroundpress),b.selector.bg.mouseover(b.backgroundover),$("html").unbind("mousemove"),$("html").unbind("mouseup"),$("html").on("mousemove",b.workspacemove),$("html").on("mouseup",b.workspacerelease),b.selector.base.mousedown(b.selectorpress),$.each([b.selector.circle_se,b.selector.circle_sw,b.selector.circle_ne,b.selector.circle_nw,b.selector.circle_s,b.selector.circle_n,b.selector.circle_w,b.selector.circle_e],function(a,c){c.mousedown(function(a){b.resizepress(c,a)})}),$.each([b.selector.curvedleft,b.selector.curvedanchorleft,b.selector.curvedanchorright,b.selector.curvedright],function(a,c){c.mousedown(function(a){b.reshapepress(c,a)})}),b.selector.rotate.mouseover(b.rotatehover),b.selector.rotate.mousedown(b.rotatepress)),b.createstatelist(b.drawningboard.background),b.drawningboard.background.pushstate()},b.setnewclipstate=function(a){var c=a.y;a.alpha=0,a.y=1e3,a.pushstate();for(var d=0;d<=b.drawningboard.currentstate;d++)a.pushstate();a.alpha=1,a.y=c},b.createstatelist=function(a){a.pushstate=function(){b.drawningboard.currentstate<a.statelist.length&&a.statelist.splice(b.drawningboard.currentstate+1);var c={x:a.x,y:a.y,scalex:a.scalex,scaley:a.scaley,alpha:a.alpha,index:a.index,flipx:a.flipx,flipy:a.flipy,color:a.color.clone(),rotation:a.rotation,groupid:a.groupid};a.format&&(c.format=a.format.clone(),c.curvedleftx=a.curvedline.left.x,c.curvedlefty=a.curvedline.left.y,c.curvedanchorleftx=a.curvedline.anchorleft.x,c.curvedanchorlefty=a.curvedline.anchorleft.y,c.curvedanchorrightx=a.curvedline.anchorright.x,c.curvedanchorrighty=a.curvedline.anchorright.y,c.curvedrightx=a.curvedline.right.x,c.curvedrighty=a.curvedline.right.y,c.reshape=a.curvedline.enabled,c.width=a.width,c.height=a.height),a.statelist.push(c)},a.undo=function(){b.endexplodedmode();var c=a.statelist[b.drawningboard.currentstate];a.setstate(a,c,"undo")},a.redo=function(){b.endexplodedmode();var c=a.statelist[b.drawningboard.currentstate];a.setstate(a,c,"redo")},a.setstate=function(a,b,c){a.x=b.x,a.y=b.y,a.scalex=b.scalex,a.scaley=b.scaley,a.alpha=b.alpha,a.index=b.index,a.flipx=b.flipx,a.flipy=b.flipy,a.color=b.color.clone(),a.rotation=b.rotation,a.groupid=b.groupid,a.format&&(a.format=b.format.clone(),a.curvedline.left.x=b.curvedleftx,a.curvedline.left.y=b.curvedlefty,a.curvedline.anchorleft.x=b.curvedanchorleftx,a.curvedline.anchorleft.y=b.curvedanchorlefty,a.curvedline.anchorright.x=b.curvedanchorrightx,a.curvedline.anchorright.y=b.curvedanchorrighty,a.curvedline.right.x=b.curvedrightx,a.curvedline.right.y=b.curvedrighty,a.curvedline.enabled=b.reshape,a.width=b.width,a.height=b.height),a.update(c)}},b.unwatchtimer=function(){clearTimeout(b.unselectimer),b.unselectimer=setTimeout(function(){b.selected||b.multiselection||b.unselect()},500)},b.delete=function(){if(b.closecontext(),void 0!=b.target&&b.selected&&!(b.target instanceof Array&&0==b.target.length||b.deleting||b.drawningboard.ownermode&&b.drawningboard.selector.targethavecompanytext())){b.deleting=!0;var a=new Messagebox(b.drawningboard,b.drawningboard.api.dictionary.context_delete_message,b.deleteCall,b.drawningboard.api.dictionary.yes,b.drawningboard.api.dictionary.no,b.deleteReturn);a.show()}},b.deleteReturn=function(){b.deleting=!1},b.deleteCall=function(){b.selected&&(b.changed=1,$.each(b.target,function(a,c){b.deleteaction(c)}),b.refreshindex(),b.unselect(),b.save())},b.deleteaction=function(a){a.alpha=0,a.y=1e3,a.update()},b.back=function(){b.closecontext(),b.target.sort(b.compareclip);var a=0,c=b.drawningboard.cliplist.length+1;if(b.explodedmode){$.each(b.target,function(b,d){a<d.subid&&(a=d.subid),c>d.subid&&(c=d.subid)});var d=[],e=[],f=b.target.length;if($.each(b.explodedtarget,function(a,b){c-1==b.subid&&d.push(b),c-1>b.subid&&e.push(b)}),d.length>0){$.each(e,function(a,b){b.subid=b.subid-f});var g=c-f-1;$.each(b.target,function(a,b){b.subid=g,g++}),b.refreshindex(),b.changed=1,b.save()}}else{$.each(b.target,function(b,d){a<d.index&&(a=d.index),c>d.index&&(c=d.index)});var d=[],e=[],f=b.target.length;if($.each(b.drawningboard.cliplist,function(a,b){c-1==b.index&&d.push(b),c-1>b.index&&e.push(b)}),d.length>0){$.each(e,function(a,b){b.index=b.index-f});var g=c-f-1;$.each(b.target,function(a,b){b.index=g,g++}),b.refreshindex(),b.changed=1,b.save()}}},b.front=function(){b.closecontext(),b.target.sort(b.compareclip);var a=0,c=b.drawningboard.cliplist.length+1;if(b.explodedmode){$.each(b.target,function(b,d){a<d.subid&&(a=d.subid),c>d.subid&&(c=d.subid)});var d=[],e=[],f=b.target.length;if($.each(b.explodedtarget,function(b,c){a+1==c.subid&&d.push(c),a+1<c.subid&&e.push(c)}),d.length>0){$.each(e,function(a,b){b.subid=b.subid+f});var g=a+2;$.each(b.target,function(a,b){b.subid=g,g++}),b.refreshindex(),b.changed=1,b.save()}}else{$.each(b.target,function(b,d){a<d.index&&(a=d.index),c>d.index&&(c=d.index)});var d=[],e=[],f=b.target.length;if($.each(b.drawningboard.cliplist,function(b,c){a+1==c.index&&d.push(c),a+1<c.index&&e.push(c)}),d.length>0){$.each(e,function(a,b){b.index=b.index+f});var g=a+2;$.each(b.target,function(a,b){b.index=g,g++}),b.refreshindex(),b.changed=1,b.save()}}},b.backall=function(){b.closecontext(),b.changed=1,b.target.sort(b.compareclip);var a=-b.target.length;b.explodedmode?$.each(b.target,function(b,c){c.subid=a,a++}):$.each(b.target,function(b,c){c.index=a,a++}),b.refreshindex(),b.save()},b.frontall=function(){b.closecontext(),b.changed=1,b.target.sort(b.compareclip);var a=b.drawningboard.cliplist.length+1;b.explodedmode?$.each(b.target,function(b,c){c.subid=a,a++}):$.each(b.target,function(b,c){c.index=a,a++}),b.refreshindex(),b.save()},b.refreshindex=function(){var a=0;b.drawningboard.workspace.add(b.selector.bg),b.drawningboard.workspace.add(b.selector.multiarea),b.drawningboard.workspace.add(b.selector.lowergroup),b.drawningboard.cliplist.sort(b.compareclip),$.each(b.drawningboard.cliplist,function(c,d){d.enabled()&&(a++,d.index=a,d.update(),b.drawningboard.workspace.add(d.group))}),b.drawningboard.workspace.add(b.selector.uppergroup),b.drawningboard.workspace.add(b.selector.highlightgroup),b.target.length>1&&b.drawningboard.contexttab.loadiconelements()},b.compareclip=function(a,b){return a.index<b.index?-1:a.index==b.index&&a.subid<b.subid?-1:1},b.getnewindex=function(a){var c=0,d=0;return $.each(b.drawningboard.cliplist,function(b,e){e.enabled()&&e.index>c&&(c=e.index),e.id==a&&(d=e.index)}),0==d&&(d=c+1),d},b.flipvertical=function(){0!=b.rotation&&b.select(b.target,1),b.changed=1,b.closecontext(),$.each(b.target,function(a,c){c.flipy=0==c.flipy?1:0;var d=calc.rotatePoint(c.x,c.y,b.x,b.y,180);0!=c.rotation&&(c.rotation=360-c.rotation),c.y=d.y,c.update()}),1==b.target.length&&b.target[0]instanceof Text&&b.getcurveddata(),b.update(),b.save()},b.fliphorizontal=function(){0!=b.rotation&&b.select(b.target,1),b.changed=1,b.closecontext(),$.each(b.target,function(a,c){c.flipx=0==c.flipx?1:0;var d=calc.rotatePoint(c.x,c.y,b.x,b.y,180);0!=c.rotation&&(c.rotation=360-c.rotation),c.x=d.x,c.update()}),1==b.target.length&&b.target[0]instanceof Text&&b.getcurveddata(),b.save()},b.upscale=function(a){a||(a=.01),b.relativeset||b.resizepress(),b.scalex+=a,b.scaley+=a,b.settargetscale(b.scalex,b.scaley)},b.downscale=function(a){a||(a=.01),b.relativeset||b.resizepress(),b.scalex-=a,b.scaley-=a,b.settargetscale(b.scalex,b.scaley)},b.setscale=function(a,c){b.relativeset||b.resizepress(),b.settargetscale(a,c)},b.rotateleft=function(){b.relativeset||b.rotatepress(),b.rotation--,b.settargetrotation(b.rotation)},b.rotateright=function(){b.relativeset||b.rotatepress(),b.rotation++,b.settargetrotation(b.rotation)},b.center=function(){b.gettargetdata();var a=b.drawningboard.width/2-b.x,c=b.drawningboard.height/2-b.y;b.settargetpositionoffset(b.target,a,c)},b.moveup=function(a){b.settargetpositionoffset(b.target,0,-a)},b.movedown=function(a){b.settargetpositionoffset(b.target,0,a)},b.moveleft=function(a){b.settargetpositionoffset(b.target,-a,0)},b.moveright=function(a){b.settargetpositionoffset(b.target,a,0)},b.settargetpositionoffset=function(a,c,d){b.selected&&(b.closecontext(),b.changed=1,a instanceof Array&&($.each(a,function(a,b){b.x+=c,b.y+=d,b.update()}),b.x+=c,b.y+=d),b.update())},b.settargetposition=function(a,c,d){if(b.selected){b.closecontext(),b.changed=1;var e=b.checklimits(c,d);$.each(a,function(a,b){e.x&&(b.x=c+b.offset.x),e.y&&(b.y=d+b.offset.y),b.update()}),e.x&&(b.x=c+b.offset.x),e.y&&(b.y=d+b.offset.y),b.update()}},b.getcoordsoffset=function(a,b,c){return corners={x1:b+a.offset.x-a.width*a.scalex*.5,y1:c+a.offset.y-a.height*a.scaley*.5,x2:b+a.offset.x-a.width*a.scalex*.5,y2:c+a.offset.y+a.height*a.scaley*.5,x3:b+a.offset.x+a.width*a.scalex*.5,y3:c+a.offset.y-a.height*a.scaley*.5,x4:b+a.offset.x+a.width*a.scalex*.5,y4:c+a.offset.y+a.height*a.scaley*.5,xc:b+a.offset.x,yc:c+a.offset.y}},b.getrotatedcoordsoffset=function(a,c,d){var e=b.getcoordsoffset(a,c,d),f=calc.rotatePoint(e.x1,e.y1,e.xc,e.yc,-a.rotation),g=calc.rotatePoint(e.x2,e.y2,e.xc,e.yc,-a.rotation),h=calc.rotatePoint(e.x3,e.y3,e.xc,e.yc,-a.rotation),i=calc.rotatePoint(e.x4,e.y4,e.xc,e.yc,-a.rotation),j={x1:f.x,y1:f.y,x2:g.x,y2:g.y,x3:h.x,y3:h.y,x4:i.x,y4:i.y,xc:e.xc,yc:e.yc};return j},b.checklimits=function(a,c){var d=!0,e=!0,f=b.drawningboard.width-b.pixellimit,g=b.drawningboard.height-b.pixellimit;return $.each(b.target,function(h,i){var j=b.getrotatedcoordsoffset(i,a,c),k=[];k.x1=j.x1<b.pixellimit||j.x1>f,k.x2=j.x2<b.pixellimit||j.x2>f,k.x3=j.x3<b.pixellimit||j.x3>f,k.x4=j.x4<b.pixellimit||j.x4>f,k.xc=j.xc<b.pixellimit||j.xc>f,k.y1=j.y1<b.pixellimit||j.y1>g,k.y2=j.y2<b.pixellimit||j.y2>g,k.y3=j.y3<b.pixellimit||j.y3>g,k.y4=j.y4<b.pixellimit||j.y4>g,k.yc=j.yc<b.pixellimit||j.yc>g,k.p1=k.x1||k.y1,k.p2=k.x2||k.y2,k.p3=k.x3||k.y3,k.p4=k.x4||k.y4,k.pc=k.xc||k.yc,k.p1&&k.p2&&k.p3&&k.p4&&k.pc&&(k.x1&&k.x2&&k.x3&&k.x4&&k.xc&&(d=!1),k.y1&&k.y2&&k.y3&&k.y4&&k.yc&&(e=!1))}),{x:d,y:e}},b.settargetrotation=function(a){0>a?a+=360:a>=360&&(a-=360),b.closecontext(),b.rotation=a,b.changed=1,$.each(b.target,function(c,d){d.rotation=a+d.relativemeasures.rotation-b.relativemeasures.rotation;var e=calc.rotatePoint(d.relativemeasures.xc,d.relativemeasures.yc,b.relativemeasures.xc,b.relativemeasures.yc,-a+b.relativemeasures.rotation);d.x=e.x,d.y=e.y,d.update()}),b.update()},b.settargetscale=function(a,c){b.changed=1;var d=(b.relativemeasures.width-2*b.selectionborderw)*a+2*b.selectionborderw,e=(b.relativemeasures.height-2*b.selectionborderh)*c+2*b.selectionborderh;$.each(b.target,function(f,g){a&&d>=20&&(g.scalex=g.relativemeasures.scalex*a,g.x=b.x-g.relativemeasures.offx*a),c&&e>=20&&(g.scaley=g.relativemeasures.scaley*c,g.y=b.y-g.relativemeasures.offy*c),g.update()}),b.gettargetscaledata(),b.update()},b.reshape=function(){b.drawningboard.selector.closecontext();var a=b.target[0];a.curvedline.enabled&&(a.curvedline.x=a.x,a.curvedline.y=a.y),a.rotation=0,b.rotation=0,a.flipx=0,a.flipy=0,b.reshaperelease();var c=a.x,d=a.y;b.reshaperelease(),a.x=c,a.y=d,a.update(),b.reshaperelease(),b.gettargetdata(),a.curvedline.enabled?b.updateselector(!0):(b.updateselector(),a.curvedline.start?a.curvedline.start=!1:(a.x=a.curvedline.x,a.y=a.curvedline.y,a.update(),b.gettargetdata())),b.update(),b.drawningboard.contexttab.updatepreview()},b.group=function(){if(1==b.target.length)b.target[0].groupid=0,b.changed=!0,b.save(),b.select(b.target,1);else{var a=!1,c=0;$.each(b.target,function(b,d){return 0==d.groupid?void(a=!0):0!=d.groupid&&d.groupid!=c&&0!=c?void(a=!0):void(c==d.groupid)}),a?(b.drawningboard.groupid++,$.each(b.target,function(a,c){c.groupid=b.drawningboard.groupid}),b.changed=!0,b.save(),b.select(b.target,1)):($.each(b.target,function(a,b){b.groupid=0}),b.changed=!0,b.save(),b.unselect())}},b.copycolors=function(){var a=b.target[0];b.colorcopytarget=a.color.clone()},b.pastecolors=function(){b.closecontext(),b.colorcopytarget&&($.each(b.target,function(a,c){c.color=b.colorcopytarget.clone(),c.update()}),b.update(),b.drawningboard.contexttab.select(b.target),b.changed=1,b.save())},b.copy=function(){b.selected?(b.copytarget=b.target,b.pastecount=1):b.copytarget=[]},b.paste=function(){if(0!=b.copytarget.length){var a=[];if(b.explodedmode){var c=0;$.each(b.explodedtarget,function(a,b){b.subid>c&&(c=b.subid)}),$.each(b.copytarget,function(d,e){if(e instanceof Clip){c++;var f=new Clip(e.path,e.color.clone(),b.drawningboard);f.x=e.x+20*b.pastecount,f.y=e.y+20*b.pastecount,f.realposition=!0,f.id=e.id,f.subid=c,f.scalex=e.scalex,f.scaley=e.scaley,f.rotation=e.rotation,f.flipx=e.flipx,f.flipy=e.flipy,f.start(),b.explodedtarget.push(f),b.setnewclipstate(f),a.push(f)}else e instanceof Text&&(c++,f=new Text(e.format.text,e.format.font,e.scale,e.color.clone(),b.drawningboard,e.x+20*b.pastecount,e.y+20*b.pastecount,e.id),f.format.size=e.format.size,f.subid=c,f.format.bold=e.format.bold,f.format.italic=e.format.italic,f.rotation=e.rotation,f.flipx=e.flipx,f.flipy=e.flipy,f.scalex=e.scalex,f.scaley=e.scaley,f.realposition=!0,f.width=e.width,f.height=e.height,f.curvedline.enabled=e.curvedline.enabled,f.curvedline.startheight=e.curvedline.startheight,f.curvedline.startwidth=e.curvedline.startwidth,f.curvedline.left.x=e.curvedline.left.x,f.curvedline.left.y=e.curvedline.left.y,f.curvedline.anchorleft.x=e.curvedline.anchorleft.x,f.curvedline.anchorleft.y=e.curvedline.anchorleft.y,f.curvedline.anchorright.x=e.curvedline.anchorright.x,f.curvedline.anchorright.y=e.curvedline.anchorright.y,f.curvedline.right.x=e.curvedline.right.x,f.curvedline.right.y=e.curvedline.right.y,f.curvedline.type=e.curvedline.type,f.start(),b.explodedtarget.push(f),b.setnewclipstate(f),a.push(f))})}else{var d=[];$.each(b.copytarget,function(c,d){if(d instanceof Clip){b.drawningboard.clipid++;var e=new Clip(d.path,d.color.clone(),b.drawningboard);e.x=d.x+20*b.pastecount,e.y=d.y+20*b.pastecount,e.realposition=!0,e.id=b.drawningboard.clipid,e.scalex=d.scalex,e.scaley=d.scaley,e.rotation=d.rotation,e.flipx=d.flipx,e.flipy=d.flipy,e.start(),b.setnewclipstate(e),a.push(e)}else d instanceof Text&&(b.drawningboard.clipid++,e=new Text(d.format.text,d.format.font,d.scale,d.color.clone(),b.drawningboard,d.x+20*b.pastecount,d.y+20*b.pastecount,b.drawningboard.clipid),e.format.size=d.format.size,e.rotation=d.rotation,e.format.bold=d.format.bold,e.format.italic=d.format.italic,e.flipx=d.flipx,e.flipy=d.flipy,e.scalex=d.scalex,e.scaley=d.scaley,e.realposition=!0,e.reshape=d.reshape,e.width=d.width,e.height=d.height,e.curvedline.enabled=d.curvedline.enabled,e.curvedline.startheight=d.curvedline.startheight,e.curvedline.startwidth=d.curvedline.startwidth,e.curvedline.left.x=d.curvedline.left.x,e.curvedline.left.y=d.curvedline.left.y,e.curvedline.anchorleft.x=d.curvedline.anchorleft.x,e.curvedline.anchorleft.y=d.curvedline.anchorleft.y,e.curvedline.anchorright.x=d.curvedline.anchorright.x,e.curvedline.anchorright.y=d.curvedline.anchorright.y,e.curvedline.right.x=d.curvedline.right.x,e.curvedline.right.y=d.curvedline.right.y,e.curvedline.type=d.curvedline.type,e.start(),b.setnewclipstate(e),a.push(e))});var e;$.each(d,function(c,d){if(e!=d.id&&b.drawningboard.clipid++,e=d.id,d instanceof Clip){var f=new Clip(d.path,d.color.clone(),b.drawningboard);f.x=d.x+20*b.pastecount,f.y=d.y+20*b.pastecount,f.realposition=!0,f.id=b.drawningboard.clipid,f.subid=d.subid,f.scalex=d.scalex,f.scaley=d.scaley,f.rotation=d.rotation,f.flipx=d.flipx,f.flipy=d.flipy}else d instanceof Text&&(f=new Text(d.format.text,d.format.font,d.scale,d.color.clone(),b.drawningboard,d.x+20*b.pastecount,d.y+20*b.pastecount,b.drawningboard.clipid),f.format.size=d.format.size,f.rotation=d.rotation,f.format.bold=d.format.bold,f.format.italic=d.format.italic,f.flipx=d.flipx,f.flipy=d.flipy,f.scalex=d.scalex,f.scaley=d.scaley,f.subid=d.subid,f.realposition=!0,f.reshape=d.reshape,f.width=d.width,f.height=d.height,f.curvedline.enabled=d.curvedline.enabled,f.curvedline.startheight=d.curvedline.startheight,f.curvedline.startwidth=d.curvedline.startwidth,f.curvedline.left.x=d.curvedline.left.x,f.curvedline.left.y=d.curvedline.left.y,f.curvedline.anchorleft.x=d.curvedline.anchorleft.x,f.curvedline.anchorleft.y=d.curvedline.anchorleft.y,f.curvedline.anchorright.x=d.curvedline.anchorright.x,f.curvedline.anchorright.y=d.curvedline.anchorright.y,f.curvedline.right.x=d.curvedline.right.x,f.curvedline.right.y=d.curvedline.right.y,f.curvedline.type=d.curvedline.type);f.start(),b.setnewclipstate(f),a.push(f)})}b.changed=1,b.save(),b.pastecount++,b.target=a,setTimeout(function(){b.refreshindex(),b.select(b.target,!0)},100)}},b.getrelativemeasures=function(a,c,d){b.relativeset=1;var e=b.getclick(a),f=b.getcoords(c),g=b.getrotatedcoords(c),h=calc.rotatePoint(e.x,e.y,b.x,b.y,b.rotation);if(d)var i=calc.getRadianFromDegree(calc.fixDegree(d.angle)),j=d.xfactor*b.width+f.x1,k=d.yfactor*b.height+f.y1,l=calc.rotatePoint(j,k,g.xc,g.yc,180),m=calc.rotatePoint(j,k,g.xc,g.yc,180-b.rotation);return{width:c.width,height:c.height,distance:a?calc.getDistance(g.xc,g.yc,e.x,e.y):0,distancex:Math.abs(g.xc-e.x),distancey:Math.abs(g.yc-e.y),clickradian:calc.getRadian(g.xc,g.yc,e.x,e.y),resizeradian:i?i:0,resizeopx:l?Math.ceil(l.x):0,resizeopy:l?Math.ceil(l.y):0,resizerelopx:m?Math.ceil(m.x):0,resizerelopy:m?Math.ceil(m.y):0,curvedx:g.xc-h.x,curvedy:g.yc-h.y,distancenw:a?calc.getDistance(g.x1,g.y1,e.x,e.y):0,distancesw:a?calc.getDistance(g.x2,g.y2,e.x,e.y):0,distancene:a?calc.getDistance(g.x3,g.y3,e.x,e.y):0,distancese:a?calc.getDistance(g.x4,g.y4,e.x,e.y):0,x:g.x1,y:g.y1,xc:g.xc,yc:g.yc,coords:g,scalex:c.scalex,scaley:c.scaley,resize:d,offx:b.x-g.xc,offy:b.y-g.yc,rotation:c.rotation}},b.getoffset=function(a,c){var d=b.getclick(c),e=b.getcoords(a);return{x:c?e.xc-d.x:0,y:c?e.yc-d.y:0}},b.getclick=function(a){return b.drawningboard.isTouch?{x:a?a.touches[0].pageX-b.drawningboard.position.left:0,y:a?a.touches[0].pageY-b.drawningboard.position.top:0}:{x:a?a.clientX-b.drawningboard.position.left:0,y:a?a.clientY-b.drawningboard.position.top:0}},b.starttransform=function(){b.selected?b.moveselected=!0:(b.moveselected=!1,b.selected=!0)},b.endtransform=function(){b.selected=b.moveselected,b.unwatchtimer()},b.start()};