SaveDialog=function(a){var b=this;b.drawningboard=a,b.dom,b.status,b.type,b.category,b.callback,b.success=!1,b.show=function(){b.drawningboard.api.loadTemplate("savedialog",function(a){b.dom=$(a),$("#logobody").append(b.dom),b.dom.hide(),b.dom.fadeIn(200),b.drawningboard.messagemenu=b,b.loadcategories()})},b.loadcategories=function(){$.ajax({type:"post",url:b.drawningboard.api.category+"list",dataType:"json"}).done(function(a){$.each(a.obj,function(a,c){c.description=b.drawningboard.api.dictionary["category_"+c.id],void 0==c.description&&(c.description="undefined")});var c=a.obj;c.sort(function(a,b){return a.description.toUpperCase()>b.description.toUpperCase()?1:a.description<b.description?-1:void 0}),b.objcategorylist=c,b.status=b.dom.find(".status select"),b.type=b.dom.find(".type select"),b.category=b.dom.find(".category select"),b.registerevents(),$.each(b.objcategorylist,function(a,c){var d=$("<option>"+c.description+"</option>");d.attr("value",c.id),b.category.append(d),c.subcategory&&$.each(c.subcategory,function(a,c){var d=$("<option>- "+c.description+"</option>");d.attr("value",c.id),b.category.append(d)})})})},b.registerevents=function(){b.dom.find(".close, .cancel").on("mouseup",b.hide),b.dom.find(".add").on("mouseup",b.save),b.type.on("change",function(){1==$(this).val()?b.category.removeAttr("disabled"):b.category.attr("disabled","disabled")})},b.save=function(){1==b.type.val()?b.saveicon():b.saveshape()},b.geticondata=function(){var a=[];$.each(b.drawningboard.cliplist,function(b,c){!c.companytext&&c.enabled()&&a.push(c)});var c=b.drawningboard.selector.getclipdata(a),d={},e=!1,f=.5;if($.each(b.drawningboard.cliplist,function(a,b){b instanceof Text&b.enabled()&&(e=!0,b.scalex>f&&(f=b.scalex))}),e)var g=90*f;else var g=0;d.width=parseInt(c.width+2*g+40),d.height=parseInt(c.height),d.dominant_color=b.getDominantColor(),b.drawningboard.showbackground&&(d.background_color=b.drawningboard.background.color.colorlist[0].color),d.category_list=[],d.shape_list=[],d.text_list=[],d.owner_id=b.drawningboard.ownerid;var h=1;return $.each(b.drawningboard.cliplist,function(a,b){if(b instanceof Clip&&b.enabled()){var e=b.svg,f=$(e.node).clone().wrap("<div></div>").parent().html().replaceAll("'","");d.shape_list.push({svg:f,color:JSON.stringify(b.color),offset_x:b.x-c.x1+g,offset_y:b.y-c.y1,scale_x:b.scalex,scale_y:b.scaley,index:h,flip_x:b.flipx,flip_y:b.flipy,width:parseInt(b.width),height:parseInt(b.height),rotation:b.rotation,note:b.note,noun_id:b.nounId,group_id:b.groupid}),h++}else b instanceof Text&&b.enabled()&&!b.companytext&&(void 0==b.format.font&&(b.format.font="Amarante"),"undefined"!=typeof b.format.font&&null!=b.format.font&&(b.format.font=b.format.font.replace(/['"]+/g,"")),b.format.font=b.format.font.replace("'","").replace("'",""),d.text_list.push({format:JSON.stringify(b.format),color:JSON.stringify(b.color),flip_x:b.flipx,flip_y:b.flipy,offset_x:b.x-c.x1+g,offset_y:b.y-c.y1,rotation:b.rotation,scale_x:b.scalex,scale_y:b.scaley,width:parseInt(b.width),height:parseInt(b.height),curvedline:JSON.stringify(b.curvedline),index:h,group_id:b.groupid}),h++)}),d},b.getDominantColor=function(){var a=[];return $.each(b.drawningboard.cliplist,function(b,c){if(c.enabled()){var d=parseInt(c.width*c.scalex*c.height*c.scaley/c.color.colorlist.length);$.each(c.color.colorlist,function(b,c){if("rgba(255,255,255,1)"!=c.color){var e=void 0;$.each(a,function(a,b){c.color==b.color&&(e=b)}),e?e.area=e.area+d:a.push({color:c.color,area:d})}})}}),a.sort(function(a,b){return a.area<b.area?1:-1}),a.length>0?a[0].color:void 0},b.saveicon=function(){var a=b.geticondata();if(a.status=b.status.val(),a.category_list.push({id:b.category.val()}),0==a.shape_list.length){var c=new Messagebox(b.drawningboard,b.drawningboard.api.dictionary.savedialog_icon_no_shape,null,null,b.drawningboard.api.dictionary.ok);return void c.show()}b.drawningboard.startloading();var d={logo:a,loginKey:b.drawningboard.ownerloginkey,oldid:b.drawningboard.editiconid};$.ajax({type:"post",url:b.drawningboard.api.logo+"insert",data:JSON.stringify(d),contentType:"application/json; charset=utf-8",dataType:"json"}).done(function(a){if(b.drawningboard.endloading(),1==a.status){b.success=!0;var c=new Messagebox(b.drawningboard,b.drawningboard.api.dictionary.savedialog_icon_success,null,null,b.drawningboard.api.dictionary.ok,b.hide);return c.show(),void b.drawningboard.reset()}var c=new Messagebox(b.drawningboard,a.Message,null,null,"ok");c.show()})},b.saveshape=function(){var a={},c=[];if($.each(b.drawningboard.cliplist,function(a,b){b instanceof Clip&&b.enabled()&&c.push(b)}),a.status=b.status.val(),$.each(b.drawningboard.cliplist,function(c,d){if(d instanceof Clip&&d.enabled()){var e=d.svg;e.selectAll("path, polygon, rect, circle").attr({fill:""}),a.svg=e.node.outerHTML,a.color=JSON.stringify(d.color),a.flip_x=d.flipx,a.flip_y=d.flipy,a.width=parseInt(d.width),a.height=parseInt(d.height),a.rotation=d.rotation,a.owner_id=b.drawningboard.ownerid}}),0==c.length){var d=new Messagebox(b.drawningboard,b.drawningboard.api.dictionary.savedialog_shape_empty,null,null,b.drawningboard.api.dictionary.ok);return void d.show()}if(c.length>1){var d=new Messagebox(b.drawningboard,b.drawningboard.api.dictionary.savedialog_shape_multiple,null,null,b.drawningboard.api.dictionary.ok);return void d.show()}b.drawningboard.startloading();var e={shape:a,loginKey:b.drawningboard.ownerloginkey};$.ajax({type:"post",url:b.drawningboard.api.shape+"insert",data:JSON.stringify(e),contentType:"application/json; charset=utf-8",dataType:"json"}).done(function(a){if(b.drawningboard.endloading(),1==a.status){b.success=!0;var c=new Messagebox(b.drawningboard,b.drawningboard.api.dictionary.savedialog_shape_success,null,null,b.drawningboard.api.dictionary.ok,b.hide);return c.show(),void b.drawningboard.reset()}var c=new Messagebox(b.drawningboard,a.Message,null,null,b.drawningboard.api.dictionary.ok);c.show()})},b.hide=function(){b.dom&&b.dom.fadeOut(200,function(){b.dom.remove()}),b.drawningboard.messagemenu=void 0,b.success&&b.callback&&(b.success=!1,b.callback())}};